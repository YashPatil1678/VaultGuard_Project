pipeline {
  agent any

  parameters {
    string(name: 'IMAGE_TAG', defaultValue: '', description: 'Optional: image (repo:tag) to override in deployment')
  }

  environment {
    EKS_CLUSTER_NAME = 'VaultGuard-cluster'
    EKS_REGION       = 'ap-south-1'
    NAMESPACE        = 'vault-guard'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[url: 'https://github.com/yashpatil1678/VaultGuard_Project.git']]
        ])
      }
    }

    stage('Configure kubectl') {
      steps {
        sh '''
          set -eux
          # Update kubeconfig to connect to EKS
          aws eks --region ${EKS_REGION} update-kubeconfig --name ${EKS_CLUSTER_NAME}
          
          # Verify access
          kubectl get nodes
        '''
      }
    }

    stage('Deploy to EKS') {
      steps {
        sh '''
          set -eux

          # Create namespace if it doesn't exist
          kubectl apply -f k8s/Namespace.yml

          # Apply deployment to the correct namespace
          kubectl apply -f k8s/Vault_Guard_Deployment.yml --namespace=${NAMESPACE}

          # Override image if specified
          if [ -n "${IMAGE_TAG}" ]; then
            kubectl set image deployment/vault-guard vault-guard=${IMAGE_TAG} --namespace=${NAMESPACE}
          fi

          # Apply service (if present) to same namespace
          if [ -f k8s/Service.yml ]; then
            kubectl apply -f k8s/Service.yml --namespace=${NAMESPACE}
          fi

          # List all resources in the namespace
          kubectl get all --namespace=${NAMESPACE}
        '''
      }
    }
  }

  post {
    success {
      echo "✅ CD pipeline completed successfully."
    }
    failure {
      echo "❌ CD pipeline failed — check logs above."
    }
    always {
      cleanWs()
    }
  }
}
